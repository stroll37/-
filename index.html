<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescription Generator - AGPL-3.0</title>
    <meta name="description" content="Medical prescription generation tool for licensed physicians">
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div class="container">
        <h1>åŒ»ç–—å¤„æ–¹ç”Ÿæˆå·¥å…·</h1>

        <form id="prescriptionForm">
            <!-- èº«ä»½æ ¡éªŒåŒº -->
            <div class="auth-box">
                <label for="authCode">ğŸ” æˆæƒéªŒè¯ç  (Authentication Code)</label>
                <input type="text" id="authCode" name="authCode" placeholder="è¯·æŸ¥é˜…æºç è®¡ç®—æ­¤ä»£ç " required>
                <small>* License è¯·æŸ¥çœ‹é¡µè„šï¼›éåŒ»å¸ˆä¸¥ç¦æ“ä½œï¼›æˆæƒåŸºå‡†ï¼š{{AUTH_BASE}}</small>
            </div>

            <div class="section-title">åŸºç¡€ä¿¡æ¯</div>
            <div class="form-grid">
                <div class="full-width">
                    <label>åŒ»ç–—æœºæ„åç§°</label>
                    <input type="text" name="hospitalName" placeholder="å“ˆæ¯”ä¸‹å¸‚ç¬¬ä¸€äººæ°‘åŒ»é™¢" required>
                </div>
                <div>
                    <label>å¼€å…·æ—¥æœŸ</label>
                    <input type="date" name="date" id="currentDate" required>
                </div>
                <div>
                    <label>æ¨¡æ¿é€‰æ‹©</label>
                    <select id="templateSelect">
                    </select>
                </div>
            </div>

            <div class="section-title">æ‚£è€…è¯¦æƒ…</div>
            <div class="form-grid">
                <div><label>å§“å</label><input type="text" name="name" placeholder="ä¾¯å›½ç‰" required></div>
                <div><label>æ€§åˆ«</label><input type="text" name="gender" placeholder="ç”·æ€§" required></div>
                <div><label>å¹´é¾„</label><input type="text" name="age" placeholder="29 å²" required></div>
                <div><label>ç§‘å®¤</label><input type="text" name="department" placeholder="æ™®é€šç²¾ç¥ç§‘" required></div>
                <div><label>ç—…å†å· (ID)</label><input type="text" name="patientId" placeholder="00114514" required></div>
                <div><label>è´¹åˆ«</label><input type="text" name="feeType" placeholder="è‡ªè´¹" required></div>
                <div class="full-width">
                    <label>ä¸´åºŠè¯Šæ–­</label>
                    <textarea name="diagnosis" rows="2" placeholder="å­å®«å†…è†œé€æ˜ç»†èƒè…ºç™Œ[2C76.2] ä¼´è‚ºè½¬ç§»[2D82.0] ç¡®è¯Š"
                        required></textarea>
                    <small class="helper-text">* <s>æœ›ä¸°å±•ï¼Ÿä½¿ LaTeX...</s> ä¸æ”¯æŒï¼Œè¯·å‹¿ä½¿ç”¨ LaTeX.</small>
                </div>
            </div>

            <div class="section-title">å¤„æ–¹å†…å®¹ (Rp)</div>
            <div id="drugDict" class="drug-dictionary">
                <!-- æŒ‰é’®å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="medicinesContainer">
            </div>
            <button type="button" id="addMedicine" class="btn btn-add">+ æ·»åŠ è¯å“</button>

            <div class="section-title">ç­¾åç¡®è®¤</div>
            <div class="form-grid">
                <div>
                    <label>åŒ»å¸ˆç­¾åå›¾ç‰‡ (PNG)</label>
                    <input type="file" id="signUpload" accept="image/png">
                    <small class="helper-text">è‹¥ä¸ä¸Šä¼ ï¼Œå°†ä½¿ç”¨é»˜è®¤ç­¾å</small>
                </div>
                <div><label>åŒ»å¸ˆå§“å</label><input type="text" name="doctorName" required></div>
                <div class="full-width"><label>æ€»é‡‘é¢ (ï¿¥)</label><input type="text" name="fee" required></div>
            </div>

            <button type="submit" class="btn btn-submit">ç”Ÿæˆ PDF å¤„æ–¹æ–‡æ¡£</button>
            
            <!-- Status message container -->
            <div id="statusMessage" class="status-message" style="display: none;"></div>
        </form>
    </div>

    <footer>
        <p><span class="legal-tag">æ³•å¾‹å£°æ˜ï¼š</span> éæ‰§ä¸šåŒ»å¸ˆåˆ©ç”¨æœ¬è½¯ä»¶å¼€å…·å¤„æ–¹å±è¿æ³•è¡Œä¸ºï¼Œå°†æ‰¿æ‹…ç›¸åº”åˆ‘äº‹è´£ä»»ã€‚</p>
        <p>æœ¬é¡¹ç›®åŸºäº <strong>GNU AGPL-3.0</strong> åè®®å¼€æºã€‚ä½¿ç”¨è€…æ‹¥æœ‰è·å–åŠä¿®æ”¹æºç çš„æƒåˆ©ã€‚</p>
        <a href="/source" target="_blank" class="source-link">
            ğŸ“‚ æŸ¥çœ‹å¹¶ä¸‹è½½é¡¹ç›®æºä»£ç  (Source Code)
        </a>
        <p class="version-info">Build Version: {{VERSION}} | Â© 2026 Licensed under AGPLv3</p>
    </footer>

    <script>
        // Prescription Generator Application
        (function() {
            'use strict';
            
            // Configuration
            const CONFIG = {
                drugDictionary: [
                    { name: 'æ™®ç‘å·´æ—èƒ¶å›Šï¼ˆå–œæ€å¹³ï¼‰', spec: '75mg*90ç²’/ç“¶', quantity: '1 ç“¶', usage: '150mg Bid. å£æœ' },
                    { name: 'æ°Ÿè¥¿æ±€èƒ¶å›Šï¼ˆç™¾å¿§è§£ï¼‰', spec: '20mg*7ç²’/ç›’', quantity: '3 ç›’', usage: '20mg Qd. å£æœ' },
                    { name: 'èˆæ›²æ—ç‰‡ï¼ˆå·¦æ´›å¤ï¼‰', spec: '50mg*14ç‰‡/ç›’', quantity: '2 ç›’', usage: '50mg Qd. å£æœ' },
                    { name: 'è´ä¼ç å•æŠ—æ³¨å°„æ¶²ï¼ˆå®‰ç»´æ±€ï¼‰', spec: '1%*4ml/ç“¶', quantity: '10 ç“¶', usage: '750mg Q3w. iv.' }
                ],
                minMedicines: 1,
                maxMedicines: 20
            };
            
            // DOM Elements
            const elements = {
                form: document.getElementById('prescriptionForm'),
                drugDict: document.getElementById('drugDict'),
                medicinesContainer: document.getElementById('medicinesContainer'),
                addMedicineBtn: document.getElementById('addMedicine'),
                currentDate: document.getElementById('currentDate'),
                signUpload: document.getElementById('signUpload'),
                statusMessage: document.getElementById('statusMessage')
            };
            
            // State
            let isSubmitting = false;
            
            // Initialize application
            function init() {
                setupEventListeners();
                initializeDrugDictionary();
                addInitialMedicineRow();
                setCurrentDate();
            }
            
            // Set up event listeners
            function setupEventListeners() {
                elements.form.addEventListener('submit', handleFormSubmit);
                elements.addMedicineBtn.addEventListener('click', handleAddMedicine);
                elements.medicinesContainer.addEventListener('click', handleMedicineContainerClick);
            }
            
            // Initialize drug dictionary buttons
            function initializeDrugDictionary() {
                CONFIG.drugDictionary.forEach(drug => {
                    const button = createDrugButton(drug);
                    elements.drugDict.appendChild(button);
                });
            }
            
            // Create drug button element
            function createDrugButton(drug) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'drug-dict-btn';
                button.textContent = drug.name;
                button.title = `è§„æ ¼: ${drug.spec}, ç”¨é‡: ${drug.quantity}, ç”¨æ³•: ${drug.usage}`;
                button.addEventListener('click', () => addMedicineRow(drug.name, drug.spec, drug.quantity, drug.usage));
                return button;
            }
            
            // Add medicine row to the form
            function addMedicineRow(name = '', spec = '', quantity = '', usage = '') {
                const row = createMedicineRow(name, spec, quantity, usage);
                elements.medicinesContainer.appendChild(row);
            }
            
            // Create medicine row element
            function createMedicineRow(name, spec, quantity, usage) {
                const div = document.createElement('div');
                div.className = 'medicine-item';
                div.innerHTML = `
                    <button type="button" class="btn btn-remove" aria-label="ç§»é™¤è¯å“">ç§»é™¤</button>
                    <div class="form-grid">
                        <div>
                            <label for="medicineName_${Date.now()}">è¯å“åç§°</label>
                            <input type="text" class="medicineName" value="${escapeHtml(name)}" required>
                        </div>
                        <div>
                            <label for="medicineSpec_${Date.now()}">è§„æ ¼</label>
                            <input type="text" class="medicineSpec" value="${escapeHtml(spec)}" required>
                        </div>
                        <div>
                            <label for="medicineQuantity_${Date.now()}">æ€»é‡</label>
                            <input type="text" class="medicineQuantity" value="${escapeHtml(quantity)}" required>
                        </div>
                        <div>
                            <label for="medicineUsage_${Date.now()}">ç”¨æ³•ç”¨é‡</label>
                            <input type="text" class="medicineUsage" value="${escapeHtml(usage)}" required>
                        </div>
                    </div>
                `;
                return div;
            }
            
            // Add initial medicine row
            function addInitialMedicineRow() {
                addMedicineRow('', '', '', '');
            }
            
            // Set current date
            function setCurrentDate() {
                if (elements.currentDate) {
                    elements.currentDate.valueAsDate = new Date();
                }
            }
            
            // Handle medicine container click events
            function handleMedicineContainerClick(event) {
                if (event.target.classList.contains('btn-remove')) {
                    removeMedicineRow(event.target.closest('.medicine-item'));
                }
            }
            
            // Remove medicine row
            function removeMedicineRow(row) {
                const items = document.querySelectorAll('.medicine-item');
                if (items.length > CONFIG.minMedicines) {
                    row.remove();
                } else {
                    showStatusMessage('å¤„æ–¹è‡³å°‘éœ€åŒ…å«ä¸€ç§è¯å“', 'error');
                }
            }
            
            // Handle add medicine button click
            function handleAddMedicine() {
                const items = document.querySelectorAll('.medicine-item');
                if (items.length >= CONFIG.maxMedicines) {
                    showStatusMessage(`è¯å“æ•°é‡ä¸èƒ½è¶…è¿‡${CONFIG.maxMedicines}ä¸ª`, 'error');
                    return;
                }
                
                const firstRow = items[0];
                const newRow = firstRow.cloneNode(true);
                newRow.querySelectorAll('input').forEach(input => input.value = '');
                elements.medicinesContainer.appendChild(newRow);
            }
            
            // Handle form submission
            async function handleFormSubmit(event) {
                event.preventDefault();
                
                if (isSubmitting) return;
                
                try {
                    isSubmitting = true;
                    setFormLoading(true);
                    
                    // Validate form
                    if (!validateForm()) {
                        return;
                    }
                    
                    // Collect form data
                    const formData = await collectFormData();
                    
                    // Show processing message
                    showStatusMessage('æ­£åœ¨è°ƒç”¨æœ¬åœ° XeLaTeX å¼•æ“ç”Ÿæˆ PDFï¼Œè¯·ç¨å€™...', 'info');
                    
                    console.log('æäº¤æ•°æ®åˆ°æœåŠ¡å™¨...', formData);

                    // Submit to server
                    const response = await submitFormData(formData);
                    
                    if (response.ok) {
                        // Download PDF
                        await downloadPDF(response);
                        showStatusMessage('å¤„æ–¹ç”ŸæˆæˆåŠŸï¼è¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½ä»»åŠ¡ã€‚', 'success');
                    } else {
                        // Handle error response
                        await handleErrorResponse(response);
                    }
                } catch (error) {
                    console.error('Form submission error:', error);
                    showStatusMessage('æ— æ³•è¿æ¥åˆ°æœ¬åœ°æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç¨‹åºæ§åˆ¶å°æ˜¯å¦æŠ¥é”™ï¼Œä»¥åŠæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚', 'error');
                } finally {
                    isSubmitting = false;
                    setFormLoading(false);
                }
            }
            
            // Validate form
            function validateForm() {
                const medicines = getMedicinesData();
                
                if (medicines.length === 0) {
                    showStatusMessage('å¤„æ–¹è‡³å°‘éœ€åŒ…å«ä¸€ç§è¯å“', 'error');
                    return false;
                }
                
                // Check for empty medicine fields
                for (const medicine of medicines) {
                    if (!medicine.name.trim()) {
                        showStatusMessage('è¯·å¡«å†™æ‰€æœ‰è¯å“åç§°', 'error');
                        return false;
                    }
                }
                
                return true;
            }
            
            // Collect form data
            async function collectFormData() {
                console.log('å¼€å§‹æ”¶é›†è¡¨å•æ•°æ®...');
                
                // Collect basic form data
                const data = {
                    hospitalName: elements.form.querySelector('[name="hospitalName"]').value,
                    date: elements.form.querySelector('[name="date"]').value,
                    name: elements.form.querySelector('[name="name"]').value,
                    gender: elements.form.querySelector('[name="gender"]').value,
                    age: elements.form.querySelector('[name="age"]').value,
                    department: elements.form.querySelector('[name="department"]').value,
                    patientId: elements.form.querySelector('[name="patientId"]').value,
                    feeType: elements.form.querySelector('[name="feeType"]').value,
                    diagnosis: elements.form.querySelector('[name="diagnosis"]').value,
                    doctorName: elements.form.querySelector('[name="doctorName"]').value,
                    fee: elements.form.querySelector('[name="fee"]').value,
                    authCode: elements.form.querySelector('[name="authCode"]').value
                };
                
                console.log('åŸºç¡€æ•°æ®æ”¶é›†å®Œæˆ:', data);
                
                // Add medicines data
                data.medicines = getMedicinesData();
                console.log('è¯å“æ•°æ®æ”¶é›†å®Œæˆ:', data.medicines);
                
                // Process signature image if uploaded
                const signFile = elements.signUpload.files[0];
                if (signFile) {
                    console.log('å¤„ç†ç­¾åå›¾ç‰‡...');
                    data.customSign = await processSignatureImage(signFile);
                } else {
                    console.log('æœªä¸Šä¼ ç­¾åå›¾ç‰‡ï¼Œä½¿ç”¨é»˜è®¤ç­¾å');
                }
                
                console.log('æœ€ç»ˆæäº¤æ•°æ®:', data);
                return data;
            }
            
            // Get medicines data from form
            function getMedicinesData() {
                return Array.from(document.querySelectorAll('.medicine-item')).map(item => ({
                    name: item.querySelector('.medicineName').value,
                    spec: item.querySelector('.medicineSpec').value,
                    quantity: item.querySelector('.medicineQuantity').value,
                    usage: item.querySelector('.medicineUsage').value
                }));
            }
            
            // Process signature image to base64
            async function processSignatureImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        // Extract base64 part only
                        const base64Data = reader.result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // Submit form data to server
            async function submitFormData(data) {
                return await fetch('/compile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
            }
            
            // Download PDF from response
            async function downloadPDF(response) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å¤„æ–¹ç¬º_${elements.form.name?.value || 'æœªå‘½å'}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
            
            // Handle error response
            async function handleErrorResponse(response) {
                const contentType = response.headers.get('Content-Type');
                
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    
                    if (response.status === 403) {
                        showStatusMessage(`æˆæƒå¤±è´¥: ${errorData.error}`, 'error');
                    } else {
                        showStatusMessage(`æœåŠ¡å™¨é”™è¯¯: ${errorData.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                } else {
                    showStatusMessage(`æœåŠ¡å™¨å“åº”å¼‚å¸¸ (HTTP ${response.status})`, 'error');
                }
            }
            
            // Show status message
            function showStatusMessage(message, type = 'info') {
                elements.statusMessage.textContent = message;
                elements.statusMessage.className = `status-message ${type}`;
                elements.statusMessage.style.display = 'block';
                
                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        elements.statusMessage.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Set form loading state
            function setFormLoading(loading) {
                if (loading) {
                    elements.form.classList.add('loading');
                    elements.form.querySelectorAll('button').forEach(btn => {
                        btn.disabled = true;
                    });
                } else {
                    elements.form.classList.remove('loading');
                    elements.form.querySelectorAll('button').forEach(btn => {
                        btn.disabled = false;
                    });
                }
            }
            
            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Initialize the application when DOM is loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>

</body>

</html>
